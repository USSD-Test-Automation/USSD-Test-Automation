{% if user_role == 'admin' %}
{% extends "admin_base.html" %}
{% elif user_role == 'manager' %}
{% extends "manager_base.html" %}
{% else %}
{% extends "tester_base.html" %}
{% endif %}

{% block content_header %}

{% endblock %}

{% block head_extra %}
{{ super() }}

{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="section-header" style="border-bottom:none; padding-bottom:0; margin-bottom: 15px;">
        <h2><i class="fas fa-chart-line" style="color: #f7b731; margin-right:10px;"></i> System Analytics</h2>
    </div>

    {% if current_user.role == 'manager' or current_user.role == 'admin' %}
    <div class="d-flex flex-wrap  justify-content-between" style="column-gap: 1.25rem;">
        <div class="card shadow mb-4 flex-grow-1" style="min-width: 320px; flex: 1 1 45%;">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-gray-700">Executi by Batch (Last 5 Completed)</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4" id="batchExecutionsChart">
                    {% if stats.batch_chart_labels and stats.batch_chart_labels|length > 0 %}
                    {% set max_val_batch = ([0] + stats.batch_chart_pass_data + stats.batch_chart_fail_data) | max %}
                    {% set chart_height = 200 %}
                    {% set bar_area_height = chart_height - 30 %}
                    {% set num_batches = stats.batch_chart_labels | length %}
                    {% set bar_width = 30 %}
                    {% set group_spacing = 20 %}
                    {% set total_width = num_batches * (bar_width * 2 + group_spacing) + group_spacing %}
                    <svg width="100%" height="{{ chart_height + 60 }}"
                        viewBox="0 0 {{ total_width + 20 }} {{ chart_height + 60 }}"
                        preserveAspectRatio="xMidYMid meet">
                        {% for i in range(5) %}
                        <line x1="0" y1="{{ chart_height - (i * bar_area_height / 4) }}" x2="{{ total_width }}"
                            y2="{{ chart_height - (i * bar_area_height / 4) }}" class="svg-axis-line" />
                        <text x="-5" y="{{ chart_height - (i * bar_area_height / 4) + 3 }}" class="svg-axis-label">
                            {{ (max_val_batch * i / 4) | round | int }}</text>
                        {% endfor %}
                        <line x1="0" y1="{{ chart_height }}" x2="{{ total_width }}" y2="{{ chart_height }}"
                            stroke="#333" stroke-width="1" />

                        {% for i in range(num_batches) %}
                        {% set pass_height = (stats.batch_chart_pass_data[i] / max_val_batch * bar_area_height) if
                        max_val_batch > 0 else 0 %}
                        {% set fail_height = (stats.batch_chart_fail_data[i] / max_val_batch * bar_area_height) if
                        max_val_batch > 0 else 0 %}
                        {% set x_pass = group_spacing + i * (bar_width * 2 + group_spacing) %}
                        {% set x_fail = x_pass + bar_width %}

                        <rect class="svg-bar" x="{{ x_pass }}" y="{{ chart_height - pass_height }}"
                            width="{{ bar_width }}" height="{{ pass_height }}" fill="#28a745">
                            <title>Pass: {{ stats.batch_chart_pass_data[i] }}</title>
                        </rect>
                        <rect class="svg-bar" x="{{ x_fail }}" y="{{ chart_height - fail_height }}"
                            width="{{ bar_width }}" height="{{ fail_height }}" fill="#dc3545">
                            <title>Fail: {{ stats.batch_chart_fail_data[i] }}</title>
                        </rect>
                        <text font-size="12px" style="padding-bottom: 30px;" fill="#777" x="{{ x_pass + 2 }}"
                            y="{{ chart_height + 15 }}">
                            {{ stats.batch_chart_labels[i][:13] }}{{ ' ' if stats.batch_chart_labels[i]|length > 15 else
                            '' }}
                        </text>
                        {% endfor %}
                        <text style="padding-top: 15px;" x="50%" y="{{ chart_height + 35 }}" text-anchor="middle"
                            font-size="12px" fill="#777">
                            (Green: Pass, Red: Fail)
                        </text>
                    </svg>
                    {% else %}
                    <p>No batch execution data to display.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Chart 2: Test Executions by Application (Pass/Fail) - SVG Pie Chart #}

        <div class="chart-container-wrapper">
            <h3>Executions by Application (Adhoc)</h3>
            <div class="svg-chart-container" id="appExecutionsPieChart"
                style="align-items: center; justify-content: center; overflow: visible !important;">
                {% if stats.app_chart_labels and stats.app_chart_labels|length > 0 %}
                    {% set total_app_executions = 0 %}
                    {% for i in range(stats.app_chart_pass_data|length) %}
                       {% set total_app_executions = total_app_executions + stats.app_chart_pass_data[i] + stats.app_chart_fail_data[i] %}
                    {% endfor %}

                    {% if total_app_executions > 0 %}
                        <svg width="250" height="250" viewBox="-1 -1 2 2" preserveAspectRatio="xMidYMid meet"
                            style="overflow: visible !important;">
                            <g transform="rotate(-90 0 0)">
                                {% set start_angle_deg = 0 %}
                                {% for i in range(stats.app_chart_labels|length) %}
                                {% set pass_val = stats.app_chart_pass_data[i] %}
                                {% set pass_slice_angle_deg = (pass_val / total_app_executions) * 360 if total_app_executions >
                                0 else 0 %}
                                {% if pass_val > 0 %}
                                <path class="svg-pie-slice" fill="#28a745"
                                    d="{{ make_pie_slice_path(pass_slice_angle_deg, start_angle_deg) }}">
                                    <title>{{ stats.app_chart_labels[i] }} - Pass: {{ pass_val }}</title>
                                </path>
                                {% set start_angle_deg = start_angle_deg + pass_slice_angle_deg %}
                                {% endif %}

                                {% set fail_val = stats.app_chart_fail_data[i] %}
                                {% set fail_slice_angle_deg = (fail_val / total_app_executions) * 360 if total_app_executions >
                                0 else 0 %}
                                {% if fail_val > 0 %}
                                <path class="svg-pie-slice" fill="#dc3545"
                                    d="{{ make_pie_slice_path(fail_slice_angle_deg, start_angle_deg) }}">
                                    <title>{{ stats.app_chart_labels[i] }} - Fail: {{ fail_val }}</title>
                                </path>
                                {% set start_angle_deg = start_angle_deg + fail_slice_angle_deg %}
                                {% endif %}
                                {% endfor %}
                            </g>
                        </svg>
                        <div style="margin-left: 20px; font-size:0.9em;">
                            {% for i in range(stats.app_chart_labels|length) %}
                            <p style="margin: 3px 0;">
                                <span
                                    style="display:inline-block; width:10px; height:10px; background-color:#28a745; margin-right:5px; border-radius:2px;"></span>
                                {{ stats.app_chart_labels[i] }} Pass: {{ stats.app_chart_pass_data[i] }}
                            </p>
                            <p style="margin: 3px 0 8px 0;">
                                <span
                                    style="display:inline-block; width:10px; height:10px; background-color:#dc3545; margin-right:5px; border-radius:2px;"></span>
                                {{ stats.app_chart_labels[i] }} Fail: {{ stats.app_chart_fail_data[i] }}
                            </p>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>No application execution data to display for pie chart.</p>
                    {% endif %}
                {% else %}
                  <p>No application execution data available.</p>
                {% endif %}
            </div>
        </div>

        {# Chart: EXECUTED Test Assignments by Priority - SVG Pie Chart with Percentages #}
        <div class="card shadow mb-4 flex-grow-1" style="min-width: 320px; flex: 1 1 45%;">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-gray-700">Executed Test Assignments by Priority</h6>
            </div>
            <div class="card-body" id="priorityPieChart">

                {% if stats.priority_pie_data and (stats.priority_pie_data | sum) > 0 %}
                {% set total_priority_executions = stats.priority_pie_data | sum %}

                {# Define SVG size and pie parameters #}
                {% set svg_size = 220 %} {# Overall SVG canvas size #}
                {% set pie_radius = 0.88 %} {# SLIGHTLY REDUCED: Pie radius relative to viewBox units (-1 to 1) #}
                {% set text_radius_factor = 0.6 %} {# How far from center to place text (0.0 to 1.0 of pie_radius)
                #}
                {% set min_percentage_for_text = 5 %} {# Don't show text for slices smaller than this % #}
                {% set font_size_svg_units = 0.13 %} {# Font size in viewBox units, adjust as needed #}

                <svg width="{{ svg_size }}" height="{{ svg_size }}" viewBox="-1 -1 2 2"
                    preserveAspectRatio="xMidYMid meet" class="chart-pie pt-4"
                    style="margin-bottom: 15px; overflow: visible !important;">
                    <g transform="rotate(-90 0 0)">
                        {% set current_angle_deg = 0 %}

                        {# --- START HARDCODED TEST FOR FIRST SLICE --- #}
                        {% if stats.priority_pie_labels|length > 0 and stats.priority_pie_data[0] > 0 %}
                        {% set slice_value_0 = stats.priority_pie_data[0] %}
                        {% set slice_label_0 = stats.priority_pie_labels[0] %}
                        {% set slice_color_0 = stats.priority_pie_colors[0] %}
                        {% set slice_angle_deg_0 = (slice_value_0 / total_priority_executions) * 360 %}
                        {% set slice_percentage_0 = (slice_value_0 / total_priority_executions * 100) %}

                        <path class="svg-pie-slice" fill="{{ slice_color_0 }}"
                            d="{{ make_pie_slice_path(slice_angle_deg_0, current_angle_deg, pie_radius) }}">
                            <title>{{ slice_label_0 }}: {{ slice_value_0 }} ({{ slice_percentage_0 | round(1) }}%)
                            </title>
                        </path>
                        <!-- Manually add text for the first slice for this test -->
                        {% if slice_percentage_0 >= min_percentage_for_text %}
                        {% set text_mid_angle_rad_0 = (current_angle_deg + slice_angle_deg_0 / 2) * pi / 180 %}
                        {% set text_x_0 = (pie_radius * text_radius_factor * cos(text_mid_angle_rad_0)) %}
                        {% set text_y_0 = (pie_radius * text_radius_factor * sin(text_mid_angle_rad_0)) %}
                        <text class="pie-text" x="{{ text_x_0 | round(5) }}" y="{{ text_y_0 | round(5) }}"
                            fill="#ffffff" font-size="{{ font_size_svg_units }}px" text-anchor="middle"
                            dominant-baseline="central"
                            transform="rotate(90, {{ text_x_0 | round(5) }}, {{ text_y_0 | round(5) }})">
                            {{ slice_percentage_0 | round(0) }}%
                        </text>
                        {% endif %}
                        {% set current_angle_deg = current_angle_deg + slice_angle_deg_0 %}
                        {% endif %}
                        {# --- END HARDCODED TEST FOR FIRST SLICE --- #}


                        {# Loop for subsequent slices (index 1 onwards) #}
                        {% for i in range(1, stats.priority_pie_labels|length) %} {# START LOOP FROM 1 #}
                        {% set slice_value = stats.priority_pie_data[i] %}
                        {% if slice_value > 0 %}
                        {% set slice_angle_deg = (slice_value / total_priority_executions) * 360 %}
                        {% set slice_percentage = (slice_value / total_priority_executions * 100) %}

                        <path class="svg-pie-slice" fill="{{ stats.priority_pie_colors[i] }}"
                            d="{{ make_pie_slice_path(slice_angle_deg, current_angle_deg, pie_radius) }}">
                            <title>{{ stats.priority_pie_labels[i] }}: {{ slice_value }} ({{ slice_percentage |
                                round(1) }}%)</title>
                        </path>

                        {% if slice_percentage >= min_percentage_for_text %}
                        {% set text_mid_angle_rad = (current_angle_deg + slice_angle_deg / 2) * pi / 180 %}
                        {% set text_x = (pie_radius * text_radius_factor * cos(text_mid_angle_rad)) %}
                        {% set text_y = (pie_radius * text_radius_factor * sin(text_mid_angle_rad)) %}
                        <text class="pie-text" x="{{ text_x | round(5) }}" y="{{ text_y | round(5) }}" fill="#ffffff"
                            font-size="{{ font_size_svg_units }}px" text-anchor="middle" dominant-baseline="central"
                            transform="rotate(90, {{ text_x | round(5) }}, {{ text_y | round(5) }})">
                            {{ slice_percentage | round(0) }}%
                        </text>
                        {% endif %}
                        {% set current_angle_deg = current_angle_deg + slice_angle_deg %}
                        {% endif %}
                        {% endfor %}
                    </g>
                </svg>

                {# Legend #}
                <div
                    style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; font-size:0.85em; margin-top: 10px;">
                    {% for i in range(stats.priority_pie_labels|length) %}
                    {% if stats.priority_pie_data[i] > 0 or total_priority_executions == 0 %}
                    <div class="svg-legend-item" style="margin-right: 10px; margin-bottom: 5px;">
                        <span class="svg-legend-color-box"
                            style="background-color: {{ stats.priority_pie_colors[i] }};"></span>
                        {{ stats.priority_pie_labels[i] }} ({{ stats.priority_pie_data[i] }})
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <p>No executed assignment data by priority to display.</p>
                {% endif %}
            </div>
        </div>

        {# Chart 3: Test Execution Trend (Pass/Fail over time) - SVG Line Chart #}
        <div class="card shadow mb-4 flex-grow-1" style="min-width: 320px; flex: 1 1 45%;">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-gray-700">Execution Trend Over Time (Last 7 Days)</h6>
            </div>
            <div class="card-body" id="executionTrendLineChart">
                {% if stats.execution_trend_dates and stats.execution_trend_dates|length > 0 %}
                {% set max_val_trend = ([0] + stats.execution_trend_pass_data + stats.execution_trend_fail_data) | max
                %}
                {% set chart_height = 200 %}
                {% set chart_width = 400 %}
                {% set num_points = stats.execution_trend_dates | length %}
                {% set point_gap = chart_width / (num_points - 1) if num_points > 1 else chart_width %}

                <svg class="chart-pie pt-4 p-3" width="100%" height="{{ chart_height + 50 }}"
                    viewBox="0 0 {{ chart_width + 50 }} {{ chart_height + 50 }}" preserveAspectRatio="xMidYMid meet">
                    {% for i in range(5) %}
                    <line x1="30" y1="{{ chart_height - (i * chart_height / 4) }}" x2="{{ chart_width + 30 }}"
                        y2="{{ chart_height - (i * chart_height / 4) }}" class="svg-axis-line" />
                    <text x="25" y="{{ chart_height - (i * chart_height / 4) + 5 }}" class="svg-axis-label">{{
                        (max_val_trend * i / 4) | round | int }}</text>
                    {% endfor %}
                    <line x1="30" y1="{{ chart_height }}" x2="{{ chart_width + 30 }}" y2="{{ chart_height }}"
                        stroke="#333" stroke-width="1" />

                    {% set pass_points_list = [] %}
                    {% for i in range(num_points) %}
                    {% set x = 30 + i * point_gap %}
                    {% set y = chart_height - (stats.execution_trend_pass_data[i] / max_val_trend * chart_height) if
                    max_val_trend > 0 else chart_height %}
                    {% if pass_points_list.append(x ~ "," ~ y) %}{% endif %}
                    <circle cx="{{ x }}" cy="{{ y }}" r="3" fill="#28a745">
                        <title>Pass ({{ stats.execution_trend_dates[i] }}): {{ stats.execution_trend_pass_data[i] }}
                        </title>
                    </circle>
                    {% endfor %}
                    <polyline points="{{ pass_points_list | join(' ') }}" fill="none" stroke="#28a745"
                        stroke-width="2" />

                    {% set fail_points_list = [] %}
                    {% for i in range(num_points) %}
                    {% set x = 30 + i * point_gap %}
                    {% set y = chart_height - (stats.execution_trend_fail_data[i] / max_val_trend * chart_height) if
                    max_val_trend > 0 else chart_height %}
                    {% if fail_points_list.append(x ~ "," ~ y) %}{% endif %}
                    <circle cx="{{ x }}" cy="{{ y }}" r="3" fill="#dc3545">
                        <title>Fail ({{ stats.execution_trend_dates[i] }}): {{ stats.execution_trend_fail_data[i] }}
                        </title>
                    </circle>
                    {% endfor %}
                    <polyline points="{{ fail_points_list | join(' ') }}" fill="none" stroke="#dc3545"
                        stroke-width="2" />

                    {% for i in range(num_points) %}
                    <text font-size="13px" fill="#777" x="{{ 30 + i * point_gap }}" y="{{ chart_height + 15 }}">
                        {{ stats.execution_trend_dates[i] }}
                    </text>
                    {% endfor %}
                    <text class="pt-4" x="{{ chart_width / 2 + 15}}" y="{{ chart_height + 35 }}" text-anchor="middle"
                        font-size="12px" fill="#777">(Green: Pass, Red: Fail)</text>
                </svg>
                {% else %}
                <p>No trend data to display.</p>
                {% endif %}
            </div>
        </div>


        <div class="mb-4 flex-grow-1" style="min-width: 320px; flex: 1 1 45%;">

        </div>
        {% else %}
        <div class="alert alert-danger text-center">
            You are unautorized to see analytics.<br>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

{% endblock %}

{# Jinja macro to help generate SVG pie slice paths #}
{% macro make_pie_slice_path(slice_angle_deg, start_angle_deg, radius=1) -%}
{# Ensure slice_angle is not too small to be invisible or problematic #}
{% if slice_angle_deg < 0.001 %} {# Return an empty path or a tiny dot if the angle is effectively zero #} M 0 0 {% else
    %} {# Convert angles to radians for math functions #} {% set start_rad=start_angle_deg * pi / 180 %} {% set
    end_rad=(start_angle_deg + slice_angle_deg) * pi / 180 %} {# Calculate coordinates for the arc #} {% set x1=(radius
    * cos(start_rad)) %} {% set y1=(radius * sin(start_rad)) %} {% set x2=(radius * cos(end_rad)) %} {% set y2=(radius *
    sin(end_rad)) %} {# If start and end points are numerically identical due to a full circle or tiny slice, SVG arc
    won't draw. We can make x2 infinitesimally different. #} {% if (x1|round(7)==x2|round(7)) and
    (y1|round(7)==y2|round(7)) and slice_angle_deg> 0 and slice_angle_deg < 359.999 %} {# Avoid for exact 360 #} {% set
        end_rad_adjusted=(start_angle_deg + slice_angle_deg - 0.0001) * pi / 180 %} {% set x2=(radius *
        cos(end_rad_adjusted)) %} {% set y2=(radius * sin(end_rad_adjusted)) %} {% endif %} {# Determine if the arc
        should be> 180 degrees (large-arc-flag) #}
        {% set large_arc_flag = 1 if slice_angle_deg > 180 else 0 %}

        {# Construct the SVG path data string for a pie slice #}
        M 0 0 L {{ x1 | round(7) }} {{ y1 | round(7) }} A {{ radius | round(7) }} {{ radius | round(7) }} 0 {{
        large_arc_flag }} 1 {{ x2 | round(7) }} {{ y2 | round(7) }} Z
        {% endif %}
        {%- endmacro %}